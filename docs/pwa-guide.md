# Progressive Web App (PWA) Implementation Guide

## Overview

The Dance Studio Scheduler application has been enhanced with Progressive Web App capabilities, enabling users to install the app on their devices, work offline, and receive automatic updates. This guide covers all PWA features, configuration, and usage.

## Features Implemented

### 1. App Installation

The app can be installed to the home screen on both iOS and Android devices:

- **Install Prompt**: Automatically appears after 30 seconds of use (can be dismissed)
- **Custom App Icon**: Purple gradient with dancing figure and musical notes
- **Splash Screen**: Branded splash screen during app launch
- **Standalone Mode**: Runs without browser UI when launched from home screen

### 2. Offline Capability

The app works with limited or no internet connection:

- **Offline Detection**: Real-time network status monitoring
- **Visual Indicators**: Banner displays when offline with queued action count
- **Data Caching**: Critical data cached for offline access using IndexedDB
- **Action Queue**: User actions queued when offline and synced when online

### 3. Service Worker Caching

Intelligent caching strategies for different content types:

- **Static Assets**: Cache-first for images, fonts, icons (30-day cache)
- **API Calls**: Network-first with 10-second timeout (5-minute cache)
- **Supabase Data**: Network-first with fallback (24-hour cache)
- **Stripe Calls**: Network-only (never cached for security)

### 4. Background Sync

Automatic synchronization when connection is restored:

- **Queued Actions**: Up to 5 retry attempts for failed actions
- **Periodic Sync**: Checks for updates every hour
- **Visual Feedback**: Syncing indicator shown during background sync

### 5. App Updates

Seamless update experience:

- **Auto-Update**: Service worker updates automatically
- **Update Prompt**: Notification when new version is available
- **Offline Ready**: Confirmation when app is cached for offline use

## File Structure

```
studio-scheduler/
├── public/
│   ├── icons/                    # PWA app icons
│   │   ├── icon-72x72.png
│   │   ├── icon-96x96.png
│   │   ├── icon-128x128.png
│   │   ├── icon-144x144.png
│   │   ├── icon-152x152.png
│   │   ├── icon-192x192.png
│   │   ├── icon-384x384.png
│   │   ├── icon-512x512.png
│   │   ├── icon-192x192-maskable.png
│   │   └── icon-512x512-maskable.png
│   ├── screenshots/              # App store screenshots
│   │   ├── schedule.png
│   │   └── recitals.png
│   └── icon.svg                  # Source icon
├── composables/
│   ├── usePwa.ts                 # PWA install & update logic
│   └── useOffline.ts             # Offline detection & sync
├── components/
│   ├── PwaInstallPrompt.vue      # Install prompt UI
│   ├── PwaUpdatePrompt.vue       # Update notification UI
│   └── OfflineIndicator.vue      # Offline status banner
├── utils/
│   └── offlineStorage.ts         # IndexedDB storage utility
├── plugins/
│   └── offline.client.ts         # Offline initialization
└── scripts/
    ├── generateIcons.mjs         # Icon generation script
    └── generateScreenshots.mjs   # Screenshot generation script
```

## Configuration

### nuxt.config.ts

PWA configuration in `nuxt.config.ts`:

```typescript
pwa: {
  registerType: 'autoUpdate',
  manifest: {
    name: 'Dance Studio Scheduler',
    short_name: 'Studio',
    description: 'Manage your dance studio classes, schedules, and recitals',
    theme_color: '#8B5CF6',
    background_color: '#ffffff',
    display: 'standalone',
    orientation: 'portrait',
    // ... icon and screenshot configuration
  },
  workbox: {
    // Caching strategies configured here
  },
  client: {
    installPrompt: true,
    periodicSyncForUpdates: 3600 // 1 hour
  }
}
```

### Service Worker

The service worker is automatically generated by `@vite-pwa/nuxt` with configured caching strategies.

## Usage

### For Users

#### Installing the App

**On Android (Chrome):**
1. Visit the app in Chrome browser
2. Wait for the install prompt to appear (or tap the "..." menu)
3. Tap "Install" or "Add to Home Screen"
4. The app icon will appear on your home screen

**On iOS (Safari):**
1. Visit the app in Safari
2. Tap the Share button (square with arrow)
3. Scroll down and tap "Add to Home Screen"
4. Name the app and tap "Add"

#### Using Offline

1. Open the app (works offline after first visit)
2. Access previously viewed schedules and data
3. Make changes (queued automatically)
4. When back online, changes sync automatically
5. Yellow banner shows offline status and pending actions

#### Updating the App

1. Purple banner appears when update is available
2. Tap "Update Now" to reload with latest version
3. Or tap "Later" to update on next visit

### For Developers

#### Generating Icons

Run the icon generation script:

```bash
node scripts/generateIcons.mjs
```

This generates all required icon sizes from `public/icon.svg`.

#### Generating Screenshots

Run the screenshot generation script:

```bash
node scripts/generateScreenshots.mjs
```

This creates placeholder screenshots for app store listing.

#### Testing PWA Locally

1. Build the app: `npm run build`
2. Preview: `npm run preview`
3. Open in browser and test install prompt
4. Use browser DevTools > Application > Service Workers to debug

#### Testing Offline Mode

1. Open browser DevTools (F12)
2. Go to Network tab
3. Enable "Offline" mode
4. Interact with the app
5. Check Application > IndexedDB for cached data
6. Re-enable network to test sync

## Composables

### usePwa()

Handles PWA installation and updates:

```vue
<script setup>
const {
  canInstall,           // Can app be installed?
  isInstalled,          // Is app already installed?
  showInstallPrompt,    // Should show install prompt?
  install,              // Trigger install prompt
  dismissInstallPrompt, // Dismiss install prompt
  needRefresh,          // Is update available?
  offlineReady,         // Is app cached for offline?
  updateServiceWorker   // Apply service worker update
} = usePwa()
</script>
```

### useOffline()

Manages offline state and action queue:

```vue
<script setup>
const {
  isOnline,                   // Is device online?
  isOffline,                  // Is device offline?
  actionQueue,                // Array of queued actions
  syncInProgress,             // Is sync in progress?
  queueAction,                // Add action to queue
  removeAction,               // Remove action from queue
  processQueue,               // Process all queued actions
  isFeatureAvailableOffline,  // Check if feature works offline
  getOfflineMessage,          // Get user-friendly offline message
  queuedActionCount          // Number of queued actions
} = useOffline()
</script>
```

### useOfflineStorage()

IndexedDB storage for offline data:

```vue
<script setup>
const {
  cacheSchedule,        // Cache schedule data
  getCachedSchedule,    // Get cached schedule
  cacheStudent,         // Cache student data
  getCachedStudent,     // Get cached student
  getAllCachedStudents, // Get all cached students
  cacheClass,           // Cache class data
  getCachedClass,       // Get cached class
  getAllCachedClasses,  // Get all cached classes
  cacheProfile,         // Cache user profile
  getCachedProfile,     // Get cached profile
  cacheGeneric,         // Cache any data
  getCachedGeneric,     // Get any cached data
  clearAllCache         // Clear all cached data
} = useOfflineStorage()
</script>
```

## Components

### PwaInstallPrompt

Displays install prompt after 30 seconds:

```vue
<PwaInstallPrompt />
```

Auto-imported in layouts. Dismissal is remembered for 7 days.

### PwaUpdatePrompt

Shows update notification:

```vue
<PwaUpdatePrompt />
```

Appears when new service worker version is available.

### OfflineIndicator

Displays network status:

```vue
<OfflineIndicator />          <!-- Full banner -->
<OfflineIndicator compact />   <!-- Compact badge -->
```

Shows offline status, queued action count, and sync progress.

## Offline Data Strategy

### What's Cached Automatically

- Static assets (JS, CSS, fonts, images)
- App icons and screenshots
- Previously viewed pages

### What's Cached Programmatically

- Class schedules (1-hour TTL)
- Student profiles (2-hour TTL)
- Class definitions (2-hour TTL)
- User profiles (4-hour TTL)

### What's NOT Cached

- Payment information (Stripe)
- Sensitive authentication data
- Real-time updates (must be online)

## Browser Support

### Install to Home Screen

- ✅ Chrome/Edge (Android) - Full support
- ✅ Safari (iOS 16.4+) - Full support
- ✅ Samsung Internet - Full support
- ⚠️ Firefox - Limited (no install prompt, works as PWA)

### Service Worker

- ✅ Chrome/Edge - Full support
- ✅ Safari (iOS 11.3+) - Full support
- ✅ Firefox - Full support
- ❌ IE - Not supported

### Background Sync

- ✅ Chrome/Edge - Full support
- ⚠️ Safari - Limited (no true background sync)
- ⚠️ Firefox - Limited

## Troubleshooting

### Install Prompt Not Appearing

**Check:**
1. Using HTTPS (required for PWA)
2. Visited site at least twice
3. 5-minute interval between visits
4. Not already installed
5. Browser supports PWA installation

**Solution:**
- Wait for criteria to be met
- Or use browser menu > "Install App"

### Service Worker Not Registering

**Check:**
1. HTTPS enabled (localhost ok for dev)
2. Browser console for errors
3. Service worker scope matches app location

**Solution:**
- Check browser DevTools > Application > Service Workers
- Unregister old service worker if needed
- Hard refresh (Ctrl+Shift+R)

### Offline Data Not Loading

**Check:**
1. Data was loaded at least once while online
2. Cache not expired (check TTL)
3. IndexedDB not blocked by browser

**Solution:**
- Clear browser cache and revisit while online
- Check DevTools > Application > IndexedDB
- Ensure storage quota not exceeded

### Update Not Applying

**Check:**
1. All app tabs closed
2. Service worker updated
3. Browser cache cleared

**Solution:**
- Close all app tabs
- Open app in new tab
- Click "Update Now" in prompt

## Security Considerations

### What's Safe to Cache

- Public schedule data
- Student data (encrypted in transit)
- Class information
- User profile (non-sensitive fields)

### What's NEVER Cached

- Authentication tokens (use httpOnly cookies)
- Payment information
- Stripe API keys
- Supabase service keys

### Best Practices

1. **Sensitive Data**: Never cache sensitive data
2. **TTL**: Use appropriate cache expiration times
3. **HTTPS**: Always use HTTPS in production
4. **Validation**: Re-validate cached data when online
5. **Cleanup**: Clear cache on logout

## Performance

### Bundle Size Impact

- `@vite-pwa/nuxt`: ~15 KB (gzipped)
- `workbox-window`: ~4 KB (gzipped)
- Service worker: ~25 KB (gzipped)
- **Total overhead**: ~44 KB

### Caching Benefits

- **First Load**: +44 KB overhead
- **Subsequent Loads**: 80-90% faster (cached)
- **Offline**: Full functionality for cached content

## Testing Checklist

### Installation
- [ ] Install prompt appears after 30 seconds
- [ ] App installs to home screen (Android)
- [ ] App installs to home screen (iOS)
- [ ] App icon displays correctly
- [ ] Splash screen shows during launch
- [ ] App runs in standalone mode

### Offline
- [ ] Offline banner appears when disconnected
- [ ] Previously viewed data accessible offline
- [ ] Actions queue when offline
- [ ] Queued actions sync when online
- [ ] Offline message is user-friendly

### Updates
- [ ] Update prompt appears for new version
- [ ] Update applies when clicked
- [ ] Offline ready notification shows
- [ ] Service worker updates periodically

### Caching
- [ ] Static assets cached (check Network tab)
- [ ] API responses cached appropriately
- [ ] Stripe calls never cached
- [ ] Cache expires per TTL settings

## Security and Production Configuration

### Production-Ready Features

The PWA implementation includes comprehensive security measures to prevent cross-user data leaks and ensure production safety:

#### 1. Environment-Aware Dev Options

Dev tools are automatically disabled in production builds:

```typescript
// nuxt.config.ts
devOptions: {
  enabled: process.env.NODE_ENV === 'development',
  type: 'module'
}
```

**Benefit**: Prevents debugging tools and verbose logging from exposing sensitive information in production.

#### 2. User-Specific Cache Isolation

All cached data is isolated per user to prevent cross-user data leaks:

- **Cache Keys**: Prefixed with user ID (`userId:resourceId`)
- **Automatic Clearing**: All user data cleared on logout
- **Plugin Monitoring**: Watches for user changes and clears caches automatically

**Example**:
```typescript
// User A's data
await cacheSchedule('schedule-123', data) // Stored as: userA:schedule-123

// User B cannot access User A's cached data
const data = await getCachedSchedule('schedule-123') // Returns null for User B
```

#### 3. Secure Caching Strategies

Different routes use appropriate caching strategies:

- **NetworkOnly** (Never cached):
  - Authentication endpoints (`/auth`, `/rest`)
  - Payment processing (Stripe)
  - User-specific API routes (`/api/profile`, `/api/students`, etc.)

- **NetworkFirst** (Short TTL):
  - Public API routes (5 minutes)
  - Supabase storage (24 hours)

- **CacheFirst**:
  - Static images only (30 days)

**Why**: Prevents serving stale authenticated data and ensures payment security.

#### 4. Offline Data Staleness Warnings

Users are warned when viewing potentially outdated cached data:

- **OfflineDataBanner**: Shows when offline or data is >30 minutes old
- **Last Sync Time**: Displays human-readable age of cached data
- **Retry Button**: Manually trigger sync
- **Pending Actions**: Shows count of queued actions

**Usage**:
```vue
<template>
  <OfflineDataBanner
    store-name="schedules"
    cache-key="current-schedule"
    :staleness-threshold="30"
  />
</template>
```

#### 5. Studio-Specific Branding

The PWA manifest is dynamically generated per studio for future multi-tenant support:

```
GET /api/manifest.json
```

Returns studio-customized manifest with:
- Studio name in app name
- Studio primary color as theme color
- Studio-specific description

**Cache**: 1 hour for balance between freshness and performance

### Testing Cache Isolation

To verify cache isolation works correctly:

1. **Login as User A**
   - Browse schedules/students
   - Check DevTools > Application > IndexedDB
   - Should see keys like `userA:schedule-123`

2. **Logout**
   - IndexedDB should be cleared
   - Service worker caches cleared

3. **Login as User B**
   - Browse same resources
   - Should see keys like `userB:schedule-123`
   - Should NOT see any `userA:*` keys

4. **Verify No Cross-User Access**
   - User B should never see User A's cached data
   - Each user has isolated cache namespace

### Security Best Practices

**Do's** ✅
- Always use `NetworkOnly` for authenticated routes
- Clear caches on logout
- Use user-specific cache keys
- Show staleness warnings
- Validate permissions server-side

**Don'ts** ❌
- Never cache authentication tokens
- Never cache user-specific data with `NetworkFirst`
- Never share cache between users
- Never trust cached data without validation
- Never enable dev options in production

### Detailed Security Documentation

For comprehensive security information, see:

**[PWA Security and Production Configuration Guide](./pwa-security.md)**

This guide covers:
- Production configuration details
- Cache isolation implementation
- Offline data staleness detection
- Studio-specific branding
- Complete testing checklist
- Troubleshooting guide
- Maintenance procedures

## Future Enhancements

### Planned Features

1. **Push Notifications**: Class reminders and announcements
2. **Share Target**: Share content to app from other apps
3. **File Handling**: Open PDF programs directly in app
4. **Badge API**: Show unread count on app icon
5. **Shortcuts**: Quick actions from home screen icon

### Nice to Have

- Offline form submissions
- Conflict resolution for offline edits
- Progressive image loading
- Advanced cache management UI
- Offline analytics tracking

## Resources

- [PWA Documentation](https://web.dev/progressive-web-apps/)
- [@vite-pwa/nuxt Docs](https://vite-pwa-org.netlify.app/frameworks/nuxt.html)
- [Workbox Docs](https://developer.chrome.com/docs/workbox/)
- [Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)

## Support

For issues or questions:
1. Check browser console for errors
2. Review this documentation
3. Test in incognito/private mode
4. Check DevTools > Application tab
5. Report bugs with reproduction steps
